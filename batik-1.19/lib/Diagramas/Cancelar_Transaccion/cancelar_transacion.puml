@startuml Cancelar_Transaccion_Queue_Orden_Corregido

' ðŸŽ¨ Estilo limpio y compatible con PlantUML 1.2025.3
skinparam backgroundColor white
skinparam participantBackgroundColor white
skinparam participantBorderColor black
skinparam participantFontColor black
skinparam actorBackgroundColor white
skinparam actorBorderColor black
skinparam actorFontColor black
skinparam databaseBackgroundColor white
skinparam databaseBorderColor black
skinparam databaseFontColor black
skinparam noteBackgroundColor #f9f9f9
skinparam noteBorderColor #999999
skinparam noteFontColor black

title CancelaciÃ³n de TransacciÃ³n (DB/Approvals primero, publicar en cola al final)

actor Usuario
participant "Interfaz\n(HistÃ³rico â†’ Pendientes)" as UI
participant "API Management" as APIM
participant "BHDIBP.MS.AccountTransactions\n(System_services_accounts)" as MS
participant "Approval Service\n(Aprobaciones)" as Approvals
database "DB" as DB
participant "TransactionStatusQueue\n(Azure Queue Storage)" as Queue <<queue>>
participant "Application Insights\n(TelemetrÃ­a/AuditorÃ­a)" as Insights

== ConfirmaciÃ³n en UI ==
Usuario -> UI: Click en "Cancelar"
UI -> UI: Mostrar modal de confirmaciÃ³n

alt Usuario confirma
  UI -> APIM: POST /transacciones/{id}/cancelar
  APIM -> MS: POST /transactions/{id}/cancel

  group ValidaciÃ³n de negocio
    MS -> MS: Verificar tipo de cliente y tipo de transacciÃ³n
    MS -> MS: Verificar estado actual (Ingresada | Pendiente de aprobaciÃ³n | Devuelta)
  end group

  alt CancelaciÃ³n permitida
    ' 1ï¸âƒ£ Persistencia primero
    MS -> DB: Update estado = "Revocada por cliente"
    MS -> DB: Insert auditorÃ­a (usuario, ip, fecha/hora, acciÃ³n)

    ' 2ï¸âƒ£ Aprobaciones (si aplica)
    opt Tiene aprobaciones pendientes
      MS -> Approvals: Cancelar flujo de aprobaciÃ³n (transactionId)
      Approvals --> MS: OK
      MS -> DB: Marcar aprobaciones como canceladas
    end opt

    ' 3ï¸âƒ£ TelemetrÃ­a
    MS -> Insights: Track "TransactionCanceled" {transactionId, estado="Revocada", userId}

    ' 4ï¸âƒ£ PublicaciÃ³n al FINAL
    MS -> Queue: Publicar {TransactionId,TransactionStatusId=6, TransactionStatusName="Revocada", UserId}
    Queue --> MS: ACK

    ' 5ï¸âƒ£ Respuesta al usuario
    MS --> APIM: 200 OK
    APIM --> UI: 200 OK
    UI -> Usuario: Modal de Ã©xito / refrescar "Pendientes" â†’ mover a "HistÃ³rico"

  else CancelaciÃ³n no permitida (reglas)
    MS -> Insights: Track "CancelationDenied" {transactionId, motivo, estadoActual}
    MS --> APIM: 409 / 400
    APIM --> UI: 409 / 400
    UI -> Usuario: Modal de error
  end alt

else Usuario cierra/cancela modal
  UI -> UI: Cerrar modal (sin cambios)
  UI -> Insights: Track "CancelationModalClosed"
end alt

@enduml
